#include <Wire.h> 
#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>

// I2C Addresses ที่ยืนยันแล้ว
#define BME_ADDRESS_1 0x77 
#define BME_ADDRESS_2 0x76 

Adafruit_BME280 bme1; 
Adafruit_BME280 bme2; 

// ฟังก์ชัน I2C Scanner เพื่อตรวจสอบ Address
void i2c_scanner() {
  byte error, address;
  int nDevices = 0;
  bool found_76 = false;
  bool found_77 = false;

  Serial.println("\n--- I2C Scanner (Checking 0x76 & 0x77) ---");
  
  for(address = 1; address < 127; address++ ) {
    Wire.beginTransmission(address);
    error = Wire.endTransmission();

    if (error == 0) {
      Serial.print("I2C device found at address 0x");
      if (address < 16) Serial.print("0");
      Serial.println(address, HEX);
      nDevices++;
      if (address == 0x76) found_76 = true;
      if (address == 0x77) found_77 = true;
    }
  }

  Serial.print("Total devices found: "); Serial.println(nDevices);
  
  // ตรวจสอบความสมบูรณ์
  if (found_76 && found_77) {
    Serial.println("[SUCCESS] Both 0x76 and 0x77 are visible. Proceeding to initialization.");
  } else {
    Serial.println("[FATAL ERROR] Did not find both 0x76 and 0x77. Check I2C wiring or Address Solder Jumper!");
    Serial.println("--- PROGRAM HALTED ---");
    while (1); // หยุดโปรแกรมถ้า Address ไม่ครบ
  }
}

// ------------------------------------------------------------------
// SETUP
// ------------------------------------------------------------------
void setup() {
  Serial.begin(115200);
  while (!Serial); 
  
  Serial.println("--- BME280 Dual Sensor Project Start ---");
  Wire.begin(); 
  
  // 1. รัน I2C Scanner เพื่อยืนยัน Address
  i2c_scanner();
  
  // 2. เริ่มต้น Sensor 1 (หลังจาก Scanner ยืนยัน)
  Serial.print("\n[INIT] Starting Sensor 1 (0x77)... ");
  if (!bme1.begin(BME_ADDRESS_1)) {
    Serial.println("FAIL! Sensor 1 failed initialization (Even though Scanner found it).");
    while (1); 
  }
  Serial.println("OK.");
  
  // 3. เริ่มต้น Sensor 2 (หลังจาก Scanner ยืนยัน)
  Serial.print("[INIT] Starting Sensor 2 (0x76)... ");
  if (!bme2.begin(BME_ADDRESS_2)) {
    Serial.println("FAIL! Sensor 2 failed initialization (Even though Scanner found it).");
    while (1); 
  }
  Serial.println("OK.");

  Serial.println("\n[INFO] Both sensors are ready. Entering loop...");
}

// ------------------------------------------------------------------
// LOOP
// ------------------------------------------------------------------
void loop() {
  Serial.println("\n=========================================");
  
  // อ่านและแสดงผล Sensor 1 (0x77)
  float temp1 = bme1.readTemperature();
  float hum1 = bme1.readHumidity();
  float pres1 = bme1.readPressure() / 100.0F; 
  
  Serial.println("--- Sensor 1 [0x77] ---");
  Serial.print("T: "); Serial.print(temp1); Serial.println(" °C");
  Serial.print("H: "); Serial.print(hum1); Serial.println(" %");
  
  // อ่านและแสดงผล Sensor 2 (0x76)
  float temp2 = bme2.readTemperature();
  float hum2 = bme2.readHumidity();
  float pres2 = bme2.readPressure() / 100.0F; 

  Serial.println("\n--- Sensor 2 [0x76] ---");
  Serial.print("T: "); Serial.print(temp2); Serial.println(" °C");
  Serial.print("H: "); Serial.print(hum2); Serial.println(" %");
  
  Serial.println("=========================================");
  
  delay(1000); 
}
